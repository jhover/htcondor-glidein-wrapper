#!/bin/env bash
#
# Wrapper to run Condor glidein (master + startd)
# Configured via args 
#
# Author: John Hover <jhover@bnl.gov>
#
WRAPPER_VERSION=0.9.0
CONDOR_VERSION=8.0.6
ARCH=x86_64
PLATFORM=RedHat6
TARBALL_NAME=condor-${CONDOR_VERSION}-${ARCH}_${PLATFORM}-stripped.tar.gz
TARBALL_URL=http://dev.racf.bnl.gov/dist/condor/$CONDOR_VERSION/rhel6/$ARCH/$TARBALL_NAME
CONDOR_DIR=~/condor
CONFIG=~/condor/etc/condor_config


DEFAULT_COLLECTOR=gridtest05.racf.bnl.gov
DEFAULT_COLLECTOR_PORT=29618

echo "condor_glidein version $WRAPPER_VERSION"
HOST=`hostname -f`
DATE=`date -u +"%Y-%m-%d %H:%M:%SUTC"`

echo "running on $HOST $DATE" 
cd 
WD=`pwd`
echo "working dir is $WD"
echo "creating Condor dir"
mkdir -p $CONDOR_DIR
cd $CONDOR_DIR

echo "retrieving tarball from $TARBALL_URL"
wget $TARBALL_URL

echo "unpacking tarball..."
tar --verbose --extract --gzip --strip-components=1  --file=$TARBALL_NAME

echo "running condor_install..."
./condor_install --type=execute

export CONDOR_CONFIG=$CONDOR_DIR/etc/condor_config

echo "adding COLLECTOR_HOST=$DEFAULT_COLLECTOR:$DEFAULT_COLLECTOR_PORT to config"
echo COLLECTOR_HOST=$DEFAULT_COLLECTOR:$DEFAULT_COLLECTOR_PORT >> $CONFIG



